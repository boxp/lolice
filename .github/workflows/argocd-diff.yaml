name: ArgoCD Diff Check

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'argoproj/**'

jobs:
  argocd-diff:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      repository-projects: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # å®Œå…¨ãªå±¥æ­´ã‚’å–å¾—ã—ã¦diffãŒæ­£ç¢ºã«å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹

      - name: Setup environment and ArgoCD CLI
        run: |
          # PRã§å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          git fetch origin main
          git diff --name-only origin/main..HEAD > changed_files.txt
          cat changed_files.txt

          # ArgoCD CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
          rm argocd-linux-amd64

          # kustomizeã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo install -m 555 kustomize /usr/local/bin/kustomize
          rm kustomize

          # Helmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh
          rm get_helm.sh

      - name: Connect to Tailscale (WIF keyless)
        id: tailscale
        continue-on-error: true
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          audience: ${{ secrets.TS_AUDIENCE }}
          tags: tag:ci
          hostname: gha-argocd-diff-${{ github.run_id }}

      - name: Tailscale reachability diagnostics
        id: tailscale-diag
        if: steps.tailscale.outcome == 'success'
        continue-on-error: true
        run: |
          echo "::group::tailscale status"
          tailscale status 2>&1 || true
          echo "::endgroup::"

          echo "::group::DNS resolution for lolice-argocd"
          getent hosts lolice-argocd 2>&1 || echo "getent failed; trying tailscale status grep"
          tailscale status | grep -i lolice-argocd || echo "lolice-argocd not found in tailscale status"
          echo "::endgroup::"

          echo "::group::tailscale ping lolice-argocd"
          if tailscale ping -c 3 --timeout 10s lolice-argocd 2>&1; then
            echo "::notice::tailscale ping succeeded"
          else
            echo "::warning::tailscale ping failed"
            exit 1
          fi
          echo "::endgroup::"

      - name: Determine Tailscale usability
        id: tailscale-ready
        run: |
          if [ "${{ steps.tailscale.outcome }}" = "success" ] && [ "${{ steps.tailscale-diag.outcome }}" = "success" ]; then
            echo "usable=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Tailscale connected but lolice-argocd unreachable; falling back to Cloudflare"
            echo "usable=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract applications and check for changes
        id: get-apps
        env:
          # Tailscale WIF keyless path (primary)
          ARGOCD_SERVER_TAILSCALE: "lolice-argocd"
          # Cloudflare path (fallback)
          ARGOCD_SERVER_CF: "${{ vars.ARGOCD_SERVER_URL }}"
          ARGOCD_AUTH_TOKEN: "${{ secrets.ARGOCD_AUTH_TOKEN }}"
          CF_ACCESS_CLIENT_ID: "${{ secrets.ARGOCD_API_TOKEN_ID }}"
          CF_ACCESS_CLIENT_SECRET: "${{ secrets.ARGOCD_API_TOKEN_SECRET }}"
          USE_TAILSCALE: "${{ steps.tailscale-ready.outputs.usable }}"
        run: |
          # èªè¨¼çµŒè·¯ã®æ±ºå®š
          if [ "$USE_TAILSCALE" = "true" ]; then
            echo "::notice::Using Tailscale WIF keyless path (server: $ARGOCD_SERVER_TAILSCALE)"
            export ARGOCD_SERVER="$ARGOCD_SERVER_TAILSCALE"
            AUTH_MODE="tailscale"
          else
            echo "::warning::Tailscale unavailable, falling back to Cloudflare path (server: $ARGOCD_SERVER_CF)"
            export ARGOCD_SERVER="$ARGOCD_SERVER_CF"
            AUTH_MODE="cloudflare"
          fi

          # application.yamlãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åã¨ãƒ‘ã‚¹ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆ
          echo "Finding all application.yaml files..."

          # å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆæœŸåŒ–
          echo "" > app_diff_results.md
          echo "**Auth path: ${AUTH_MODE}**" >> app_diff_results.md
          echo "" >> app_diff_results.md

          # PRã§å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç‰¹å®š
          CHANGED_DIRS=$(cat changed_files.txt | grep -E "^argoproj/" | xargs -I{} dirname {} | sort | uniq)

          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’åé›†
          declare -A APP_INFO
          while IFS= read -r app_file; do
            APP_DIR=$(dirname "$app_file")
            APP_NAME=$(grep -E "name: " "$app_file" | head -1 | awk '{print $2}')

            if [ -n "$APP_NAME" ]; then
              APP_INFO["$APP_DIR"]="$APP_NAME"
              echo "Found application: $APP_NAME in $APP_DIR"
            fi
          done < <(find argoproj -name "application.yaml")

          # å¤‰æ›´ãŒã‚ã£ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®diffã‚’å–å¾—
          FOUND_CHANGES=false
          for dir in $CHANGED_DIRS; do
            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ„ãƒªãƒ¼ã‚’ä¸Šã«é¡ã£ã¦æœ€ã‚‚è¿‘ã„application.yamlã‚’æŒã¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¢ã™
            CURRENT_DIR=$dir
            while [[ "$CURRENT_DIR" == argoproj* ]]; do
              if [ -n "${APP_INFO[$CURRENT_DIR]}" ]; then
                APP_NAME="${APP_INFO[$CURRENT_DIR]}"
                echo "Changes detected for application: $APP_NAME (in $CURRENT_DIR)"
                FOUND_CHANGES=true

                # Diffã®çµæœã‚’è¿½è¨˜
                echo "### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³: $APP_NAME ã®å·®åˆ†" >> app_diff_results.md
                echo "ãƒ‘ã‚¹: $CURRENT_DIR" >> app_diff_results.md
                echo '```diff' >> app_diff_results.md

                # Diffã‚’å–å¾—ï¼ˆæ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼‰
                REPO_ROOT=$(pwd)
                set +e  # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’çµ‚äº†ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
                # ç‰¹å®šã®warningãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                # æ³¨: "local diff without --server-side-generate is deprecated"ã®è­¦å‘Šã‚’æŠ‘åˆ¶ã—ã¦ã„ã¾ã™
                # ã“ã‚Œã¯ArgoCDå´ã®ãƒã‚°ã®ãŸã‚ã§ã™ã€‚--server-side-generateã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’--grpc-webã¨ä½µç”¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™
                # é–¢é€£issue: https://github.com/argoproj/argo-cd/discussions/13302
                if [ "$AUTH_MODE" = "tailscale" ]; then
                  argocd app diff "argocd/$APP_NAME" \
                    --grpc-web \
                    --plaintext \
                    --local-repo-root "$REPO_ROOT" \
                    --local "$REPO_ROOT/$CURRENT_DIR" 2> >(grep -v "local diff without --server-side-generate is deprecated" >&2) >> app_diff_results.md
                else
                  argocd app diff "argocd/$APP_NAME" \
                    --header "CF-Access-Client-Id: $CF_ACCESS_CLIENT_ID,CF-Access-Client-Secret: $CF_ACCESS_CLIENT_SECRET" \
                    --grpc-web \
                    --insecure \
                    --local-repo-root "$REPO_ROOT" \
                    --local "$REPO_ROOT/$CURRENT_DIR" 2> >(grep -v "local diff without --server-side-generate is deprecated" >&2) >> app_diff_results.md
                fi
                DIFF_EXIT_CODE=$?
                set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’çµ‚äº†ã™ã‚‹è¨­å®šã«æˆ»ã™

                # exit codeã«åŸºã¥ã„ã¦é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                if [ $DIFF_EXIT_CODE -eq 0 ]; then
                  echo "âœ… å·®åˆ†ãªã—" >> app_diff_results.md
                elif [ $DIFF_EXIT_CODE -eq 1 ]; then
                  echo "â„¹ï¸ ä¸Šè¨˜ã®å·®åˆ†ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ" >> app_diff_results.md
                elif [ $DIFF_EXIT_CODE -eq 2 ]; then
                  echo "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" >> app_diff_results.md
                  exit 1
                fi

                echo '```' >> app_diff_results.md
                echo "" >> app_diff_results.md
                break  # æœ€ã‚‚è¿‘ã„application.yamlãŒè¦‹ã¤ã‹ã£ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
              fi

              # è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
              CURRENT_DIR=$(dirname "$CURRENT_DIR")
            done
          done

          # å¤‰æ›´ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          if [ "$FOUND_CHANGES" = false ]; then
            echo "### å¤‰æ›´ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“" > app_diff_results.md
          fi

          echo "has_changes=$FOUND_CHANGES" >> $GITHUB_OUTPUT

      - name: Comment PR
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const diffOutput = fs.readFileSync('app_diff_results.md', 'utf8');

            function truncateContent(content) {
              const maxLength = 65000; // GitHubã®åˆ¶é™65536æ–‡å­—ã‚ˆã‚Šå°‘ã—å°ã•ãè¨­å®š
              const header = "## ArgoCD Diff Result\n\n";

              if ((header + content).length <= maxLength) {
                return header + content;
              }

              // æ–‡å­—æ•°åˆ¶é™ã‚’è¶…ãˆã‚‹å ´åˆã®å‡¦ç†
              const truncationMessage = "\n\n---\nâš ï¸ **diffå‡ºåŠ›ãŒé•·ã™ãã‚‹ãŸã‚ã€ä¸€éƒ¨å†…å®¹ã‚’çœç•¥ã—ã¾ã—ãŸ**\n\n";
              const footer = "\n\nğŸ’¡ å®Œå…¨ãªdiffã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ `argocd app diff` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚";

              // ãƒ˜ãƒƒãƒ€ãƒ¼ã€çœç•¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ãƒ•ãƒƒã‚¿ãƒ¼ã®æ–‡å­—æ•°ã‚’è¨ˆç®—
              const overhead = header.length + truncationMessage.length + footer.length;
              const availableLength = maxLength - overhead;

              // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å‰åŠã¨å¾ŒåŠã«åˆ†å‰²
              const frontLength = Math.floor(availableLength * 0.4);
              const backLength = Math.floor(availableLength * 0.4);
              const omittedLength = content.length - frontLength - backLength;

              const frontPart = content.substring(0, frontLength);
              const backPart = content.substring(content.length - backLength);

              const omittedMessage = `\n\nğŸ“ **çœç•¥ã•ã‚ŒãŸå†…å®¹**: ${omittedLength.toLocaleString()}æ–‡å­—\n\n`;

              return header + frontPart + truncationMessage + omittedMessage + backPart + footer;
            }

            const finalBody = truncateContent(diffOutput);

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: finalBody
            });
