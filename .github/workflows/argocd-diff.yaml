name: ArgoCD Diff Check

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'argoproj/**'

jobs:
  argocd-diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Get modified applications
        id: get-apps
        run: |
          CHANGED_APPS=$(find argoproj -type f -name "*.yaml" -o -name "*.yml" | grep -v "kustomization" | awk -F/ '{print $2}' | sort | uniq)
          echo "apps=$CHANGED_APPS" >> $GITHUB_OUTPUT
      
      - name: Get ArgoCD diff
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER_URL }}
          ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
          CF_ACCESS_CLIENT_ID: ${{ secrets.ARGOCD_API_TOKEN_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.ARGOCD_API_TOKEN_SECRET }}
        run: |
          for APP in ${{ steps.get-apps.outputs.apps }}; do
            echo "### アプリケーション: $APP の差分" >> diff_output.md
            echo '```diff' >> diff_output.md
            
            DIFF_OUTPUT=$(curl -s -H "CF-Access-Client-Id: $CF_ACCESS_CLIENT_ID" \
                          -H "CF-Access-Client-Secret: $CF_ACCESS_CLIENT_SECRET" \
                          -H "Authorization: Bearer $ARGOCD_AUTH_TOKEN" \
                          "$ARGOCD_SERVER/api/v1/applications/$APP/manifests" | jq -r '.')
            
            if [ -z "$DIFF_OUTPUT" ]; then
              echo "No diff found or error occurred" >> diff_output.md
            else
              echo "$DIFF_OUTPUT" >> diff_output.md
            fi
            
            echo '```' >> diff_output.md
            echo "" >> diff_output.md
          done
          
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const diffOutput = fs.readFileSync('diff_output.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ArgoCD Diff Result\n${diffOutput}`
            }); 